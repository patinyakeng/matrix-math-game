<!--
Matrix Game (Single-File) ‚Äî HTML/CSS/JS (Light iOS Theme)
Author: Alex (for Patinya/Tin)

- Light iOS-like theme
- 10 ‡∏Ç‡πâ‡∏≠, ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏°‡∏≤‡πÑ‡∏î‡πâ, ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠
- ‡∏Ç‡πâ‡∏≠ 3 ‡πÅ‡∏•‡∏∞ 10 ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á {-3,-2,-1,1,2,3}
- ‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‚Äù
- ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ Google Sheets ‡∏ú‡πà‡∏≤‡∏ô Apps Script (GAS_URL)

‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets: ‡πÉ‡∏ä‡πâ Code.gs ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (Web App, Anyone, /exec)
-->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matrix Game ‚Äì 10 Levels</title>
  <style>
    :root{
      --bg:#f9fafb; --card:#ffffff; --muted:#6b7280; --text:#111827;
      --accent:#007aff; --good:#34c759; --bad:#ff3b30; --warn:#ff9500; --border:#d1d5db;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    h1{font-size:28px;margin:0 0 12px} h2{font-size:22px;margin:0 0 8px} p{color:var(--muted)}
    label{display:block;margin:8px 0 6px}
    input,button,select{font:inherit}
    input[type="text"],input[type="number"],select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);
    }
    .row{display:flex;gap:16px;flex-wrap:wrap} .col{flex:1 1 220px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;font-weight:600}
    .btn-ghost{background:#f3f4f6;border:1px solid var(--border);color:var(--text)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
    .pill{padding:8px 12px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border);color:var(--muted)}
    .grid-nav{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin:12px 0 16px}
    .qbtn{padding:10px 0;border-radius:10px;border:1px solid var(--border);background:#f3f4f6;color:#6b7280;cursor:pointer}
    .qbtn.current{outline:2px solid var(--accent);background:#dbeafe;color:#007aff}
    .qbtn.answered{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .problem{display:flex;flex-direction:column;gap:12px}
    .mwrap{display:inline-block;border:1px solid var(--border);border-radius:10px;padding:10px;background:#f9fafb}
    table.matrix{border-collapse:collapse} table.matrix td{border:1px solid #cbd5e1;padding:6px 10px;text-align:center;min-width:32px}
    .mx{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .answer-inputs{display:inline-block} .grid-input{display:grid;gap:6px}
    .status{margin-top:8px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .end-grid{display:grid;grid-template-columns:1fr;gap:14px}
    .ans-card{border:1px solid var(--border);border-radius:12px;padding:14px;background:#f9fafb}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .hint{font-size:13px;color:var(--muted)} .ok{color:var(--good)} .no{color:var(--bad)} .warn{color:var(--warn)} .hidden{display:none} .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
  </style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN VIEW -->
  <section id="loginView" class="card">
    <h1>Matrix Game by ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏õ‡∏è‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏°‡∏∏‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢</h1>
    <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</b></p>

    <div class="row">
      <div class="col" style="max-width:180px">
        <label for="title">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
        <select id="title">
          <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
          <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
        </select>
      </div>
      <div class="col">
        <label for="name">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</label>
        <input id="name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏è‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏°‡∏∏‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢" />
      </div>
      <div class="col">
        <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
        <input id="nickname" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏¢" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="room">‡∏´‡πâ‡∏≠‡∏á</label>
        <input id="room" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.4/3" />
      </div>
      <div class="col" style="max-width:180px">
        <label for="number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
        <input id="number" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12" />
      </div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button class="btn btn-primary" id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
    </div>
    <p class="hint small">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏õ‡∏è‡∏¥‡∏ç‡∏ç‡∏≤ ‡∏°‡∏∏‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏¢‡∏ô</p>
  </section>

  <!-- QUIZ VIEW -->
  <section id="quizView" class="card hidden">
    <div class="topbar">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="pill" id="studentTag">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: -</span>
        <span class="pill" id="seedTag">‡∏ä‡∏∏‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå: -</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-ghost" id="backBtn">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <button class="btn btn-ghost" id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
        <button class="btn btn-primary" id="submitBtn" disabled>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      </div>
    </div>

    <div>
      <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠</h2>
      <div id="navGrid" class="grid-nav"></div>
    </div>

    <div id="problemArea" class="problem"></div>
    <div class="status small" id="statusLine">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: -</div>
  </section>

  <!-- END VIEW -->
  <section id="endView" class="card hidden">
    <h1>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö üéâ</h1>
    <p id="scoreLine" style="font-size:18px"></p>
    <p class="small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>

    <div id="answersList" class="end-grid"></div>

    <div class="actions" style="margin-top:16px">
      <button class="btn btn-ghost" id="playAgain">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
      <button class="btn btn-primary" id="backToHome">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>

    <div id="sheetMsg" class="hint small" style="margin-top:10px"></div>
  </section>

</div>
<script>
// ================== CONFIG ==================
const GAS_URL = "https://script.google.com/macros/s/AKfycbxORXGP88RwjAZdQ4jR3xADaSl_jwXmSWFCcvONIrt5bQ-gRXM8QFrrAN1yyGDRSATW_Q/exec";

// ================== UTILITIES ==================
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const deepCopy = (obj) => JSON.parse(JSON.stringify(obj));
const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

function makeMatrix(r, c, pick = () => randInt(-9, 9)){
  const m = []; for(let i=0;i<r;i++){ const row=[]; for(let j=0;j<c;j++){ row.push(pick()); } m.push(row); }
  return m;
}
function add(A,B){ const r=A.length, c=A[0].length; const R=makeMatrix(r,c,()=>0); for(let i=0;i<r;i++) for(let j=0;j<c;j++) R[i][j]=A[i][j]+B[i][j]; return R; }
function sub(A,B){ const r=A.length, c=A[0].length; const R=makeMatrix(r,c,()=>0); for(let i=0;i<r;i++) for(let j=0;j<c;j++) R[i][j]=A[i][j]-B[i][j]; return R; }
function scalar(A,k){ const r=A.length, c=A[0].length; const R=makeMatrix(r,c,()=>0); for(let i=0;i<r;i++) for(let j=0;j<c;j++) R[i][j]=A[i][j]*k; return R; }
function transpose(A){ const r=A.length, c=A[0].length; const R=makeMatrix(c,r,()=>0); for(let i=0;i<r;i++) for(let j=0;j<c;j++) R[j][i]=A[i][j]; return R; }
function mul2x2(A,B){ return [[A[0][0]*B[0][0]+A[0][1]*B[1][0], A[0][0]*B[0][1]+A[0][1]*B[1][1]],[A[1][0]*B[0][0]+A[1][1]*B[1][0], A[1][0]*B[0][1]+A[1][1]*B[1][1]]]; }
function det2x2(A){ return A[0][0]*A[1][1] - A[0][1]*A[1][0]; }
function det3x3(M){ const a=M[0][0], b=M[0][1], c=M[0][2]; const d=M[1][0], e=M[1][1], f=M[1][2]; const g=M[2][0], h=M[2][1], i=M[2][2]; return a*e*i + b*f*g + c*d*h - c*e*g - b*d*i - a*f*h; }
function matEq(A,B){ if(A.length!==B.length||A[0].length!==B[0].length) return false; for(let i=0;i<A.length;i++) for(let j=0;j<A[0].length;j++){ if(Number(A[i][j])!==Number(B[i][j])) return false; } return true; }
function fmtMatrixHTML(M){ let html = '<div class="mwrap"><table class="matrix">'; for(let i=0;i<M.length;i++){ html += '<tr>'; for(let j=0;j<M[0].length;j++) html += `<td>${M[i][j]}</td>`; html += '</tr>'; } html += '</table></div>'; return html; }
function fmtAnswerMatrixAsText(M){ return '['+M.map(r=>'['+r.join(', ')+']').join(', ')+']'; }
function randCoefNZ(){ const opts = [-3,-2,-1,1,2,3]; return opts[randInt(0, opts.length-1)]; }
function fmtCoefTerm(k, sym){ if(k===1) return sym; if(k===-1) return '‚àí'+sym; return (k<0? '‚àí'+Math.abs(k): String(k)) + sym; }
function fmtLinComb(k,l){ const a = fmtCoefTerm(k,'A'); const b = (l>=0? ' + ' : ' ‚àí ') + (Math.abs(l)===1? 'B' : Math.abs(l)+'B'); return a + b; }

// ================== STATE ==================
const LS_KEY = 'matrix_game_player_v3';
let player = { title:'‡∏ô‡∏≤‡∏¢', name:'', nickname:'', room:'', number:'' };
let questions = [];
let currentIndex = 0;
let seed = 0;

// ================== QUESTION GENERATORS ==================
function genQ1(){ const A = makeMatrix(2,3); const B = makeMatrix(2,3); const ans = add(A,B); return { id:1, kind:'matrix', prompt:'‡∏Ç‡πâ‡∏≠ 1) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì A + B ‡πÄ‡∏°‡∏∑‡πà‡∏≠ A, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 2√ó3', data:{A,B}, size:{r:2,c:3}, answer:ans }; }
function genQ2(){ const A = makeMatrix(3,3); const B = makeMatrix(3,3); const ans = sub(A,B); return { id:2, kind:'matrix', prompt:'‡∏Ç‡πâ‡∏≠ 2) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì A ‚àí B ‡πÄ‡∏°‡∏∑‡πà‡∏≠ A, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 3√ó3', data:{A,B}, size:{r:3,c:3}, answer:ans }; }
function genQ3(){ const A = makeMatrix(2,2); const B = makeMatrix(2,2); const k=randCoefNZ(), l=randCoefNZ(); const ans = add( scalar(A,k), scalar(B,l) ); const expr = fmtLinComb(k,l); return { id:3, kind:'matrix', prompt:`‡∏Ç‡πâ‡∏≠ 3) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ${expr} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ A, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 2√ó2`, data:{A,B,k,l}, size:{r:2,c:2}, answer:ans }; }
function genQ4(){ const base = makeMatrix(2,2); const i=randInt(0,1), j=randInt(0,1); const a=randInt(1,3), c=randInt(-5,5), xSol=randInt(-5,5), y=a*xSol+c; const A=deepCopy(base), B=deepCopy(base); A[i][j]=(a===1? 'x':(a+'x'))+(c===0?'':(c>0?('+'+c):c)); B[i][j]=y; return { id:4, kind:'solveX', prompt:'‡∏Ç‡πâ‡∏≠ 4) ‡πÉ‡∏´‡πâ A = B (‡∏Ç‡∏ô‡∏≤‡∏î 2√ó2) ‡∏à‡∏á‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ x', data:{A,B,a,c,pos:[i,j]}, size:{r:1,c:1}, answer:xSol }; }
function genQ5(){ const A = makeMatrix(2,2); const B = makeMatrix(2,2); const ans = mul2x2(A,B); return { id:5, kind:'matrix', prompt:'‡∏Ç‡πâ‡∏≠ 5) ‡∏Ñ‡∏π‡∏ì‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå A √ó B ‡πÄ‡∏°‡∏∑‡πà‡∏≠ A, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 2√ó2', data:{A,B}, size:{r:2,c:2}, answer:ans }; }
function genQ6(){ const A=makeMatrix(2,3), B=makeMatrix(3,2); const op=Math.random()<0.5?'+':'‚àí'; const At=transpose(A); const ans = op==='+'? add(At,B): sub(At,B); return { id:6, kind:'matrix', prompt:`‡∏Ç‡πâ‡∏≠ 6) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì A·µÄ ${op} B (A ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 2√ó3, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 3√ó2)`, data:{A,B,op,transposeA:true}, size:{r:3,c:2}, answer:ans }; }
function genQ7(){ const A = makeMatrix(2,2); const B = makeMatrix(2,2); const ans = add( scalar(A,2), scalar(transpose(B),3) ); return { id:7, kind:'matrix', prompt:'‡∏Ç‡πâ‡∏≠ 7) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì 2A + 3B·µÄ ‡πÄ‡∏°‡∏∑‡πà‡∏≠ A, B ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ 2√ó2', data:{A,B,transposeB:true}, size:{r:2,c:2}, answer:ans }; }
function genQ8(){ const A = makeMatrix(2,2); const ans = det2x2(A); return { id:8, kind:'number', prompt:'‡∏Ç‡πâ‡∏≠ 8) ‡∏à‡∏á‡∏´‡∏≤ det(A) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå 2√ó2', data:{A}, size:{r:1,c:1}, answer:ans }; }
function genQ9(){ const A = makeMatrix(3,3); const ans = det3x3(A); return { id:9, kind:'number', prompt:'‡∏Ç‡πâ‡∏≠ 9) ‡∏à‡∏á‡∏´‡∏≤ det(A) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå 3√ó3', data:{A}, size:{r:1,c:1}, answer:ans }; }
function genQ10(){ const A=makeMatrix(2,2), B=makeMatrix(2,2); const k=randCoefNZ(), l=randCoefNZ(); const C=add( scalar(A,k), scalar(B,l) ); const ans=det2x2(C); const expr=fmtLinComb(k,l); return { id:10, kind:'number', prompt:`‡∏Ç‡πâ‡∏≠ 10) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ${expr} ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤ det ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå 2√ó2 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ`, data:{A,B,k,l}, size:{r:1,c:1}, answer:ans }; }

function generateAllQuestions(){
  questions = [genQ1(),genQ2(),genQ3(),genQ4(),genQ5(),genQ6(),genQ7(),genQ8(),genQ9(),genQ10()];
  for(const q of questions){ q.userAnswer = (q.kind==='matrix') ? makeMatrix(q.size.r,q.size.c,()=>'' ) : ''; }
}

// ================== RENDERING ==================
const loginView = document.getElementById('loginView');
const quizView  = document.getElementById('quizView');
const endView   = document.getElementById('endView');
const startBtn  = document.getElementById('startBtn');
const studentTag= document.getElementById('studentTag');
const seedTag   = document.getElementById('seedTag');
const navGrid   = document.getElementById('navGrid');
const problemArea = document.getElementById('problemArea');
const statusLine  = document.getElementById('statusLine');
const submitBtn = document.getElementById('submitBtn');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');
const scoreLine = document.getElementById('scoreLine');
const answersList = document.getElementById('answersList');
const sheetMsg = document.getElementById('sheetMsg');
const playAgain = document.getElementById('playAgain');
const backToHome = document.getElementById('backToHome');

function show(view){ loginView.classList.add('hidden'); quizView.classList.add('hidden'); endView.classList.add('hidden'); view.classList.remove('hidden'); }

function restorePlayer(){
  try{ const raw = localStorage.getItem(LS_KEY); if(raw){ const obj = JSON.parse(raw); if(obj && obj.name){ player = obj; } } }catch(e){}
  document.getElementById('title').value = player.title || '‡∏ô‡∏≤‡∏¢';
  document.getElementById('name').value = player.name || '';
  document.getElementById('nickname').value = player.nickname || '';
  document.getElementById('room').value = player.room || '';
  document.getElementById('number').value = player.number || '';
}
function savePlayer(){ localStorage.setItem(LS_KEY, JSON.stringify(player)); }

function setupNav(){
  navGrid.innerHTML = '';
  for(let i=0;i<10;i++){ const b=document.createElement('button'); b.className='qbtn'; b.textContent=(i+1); b.addEventListener('click', ()=>{ currentIndex=i; renderQuestion(); updateNavState(); }); navGrid.appendChild(b); }
  updateNavState();
}
function updateNavState(){
  const kids = Array.from(navGrid.children);
  kids.forEach((btn,idx)=>{ btn.classList.remove('current','answered'); if(idx===currentIndex) btn.classList.add('current');
    const q=questions[idx]; const done = q.kind==='matrix' ? matrixFilled(q.userAnswer) : (q.userAnswer!=='' && q.userAnswer!==null);
    if(done) btn.classList.add('answered');
  });
}
function matrixFilled(M){ for(let i=0;i<M.length;i++) for(let j=0;j<M[0].length;j++){ if(M[i][j]===''||M[i][j]===null) return false; } return true; }

function renderQuestion(){
  const q = questions[currentIndex];
  let body = `<div><strong>${q.prompt}</strong></div>`;
  if(q.data){ if(q.data.A){ body += `<div class="mx"><span class="badge">A</span>${fmtMatrixHTML(q.data.A)}</div>`; }
              if(q.data.B){ body += `<div class="mx"><span class="badge">B</span>${fmtMatrixHTML(q.data.B)}</div>`; } }
  body += '<div class="answer-inputs">';
  if(q.kind==='matrix') body += renderMatrixInputs(q); else if(q.kind==='number') body += renderNumberInput(q); else body += renderSolveXInput(q);
  body += '</div><div class="actions"><button class="btn btn-ghost" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ</button></div>';
  problemArea.innerHTML = body;
  document.getElementById('clearBtn').addEventListener('click', ()=>{ clearCurrentAnswer(); renderQuestion(); refreshSubmitState(); updateNavState(); });
  if(q.kind==='matrix') attachMatrixInputHandlers(q); if(q.kind!=='matrix') attachNumberHandler(q);
  statusLine.textContent = `‡∏Ç‡πâ‡∏≠ ${q.id} ‡∏à‡∏≤‡∏Å 10`;
}
function renderMatrixInputs(q){ const r=q.size.r,c=q.size.c; let html = `<div class="grid-input" style="grid-template-columns: repeat(${c}, minmax(42px, 64px));">`;
  for(let i=0;i<r;i++) for(let j=0;j<c;j++){ const val = q.userAnswer[i][j]!==''? q.userAnswer[i][j] : ''; html += `<input type="number" class="minput" data-i="${i}" data-j="${j}" value="${val}" />`; }
  return html + '</div>'; }
function attachMatrixInputHandlers(q){ problemArea.querySelectorAll('input.minput').forEach(inp=>{ inp.addEventListener('input', ()=>{ const i=Number(inp.getAttribute('data-i')), j=Number(inp.getAttribute('data-j')); q.userAnswer[i][j]=inp.value; refreshSubmitState(); updateNavState(); }); }); }
function renderNumberInput(q){ const v=(q.userAnswer!=='' && q.userAnswer!==null)? q.userAnswer:''; return `<input type="number" id="ninput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°" value="${v}" />`; }
function renderSolveXInput(q){ const v=(q.userAnswer!=='' && q.userAnswer!==null)? q.userAnswer:''; return `<div class="row"><div class="col" style="max-width:260px"><label>‡∏à‡∏á‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ x (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°)</label><input type="number" id="ninput" placeholder="‡∏Ñ‡πà‡∏≤ x" value="${v}" /></div></div>`; }
function attachNumberHandler(q){ const inp=document.getElementById('ninput'); inp.addEventListener('input', ()=>{ q.userAnswer = inp.value; refreshSubmitState(); updateNavState(); }); }
function clearCurrentAnswer(){ const q=questions[currentIndex]; if(q.kind==='matrix') q.userAnswer=makeMatrix(q.size.r,q.size.c,()=>'' ); else q.userAnswer=''; }
function refreshSubmitState(){ const allDone = questions.every(q=> q.kind==='matrix' ? matrixFilled(q.userAnswer) : (q.userAnswer!=='' && q.userAnswer!==null) ); submitBtn.disabled=!allDone; }

// ================== GAME FLOW ==================
startBtn.addEventListener('click', ()=>{
  const title = document.getElementById('title').value.trim();
  const name  = document.getElementById('name').value.trim();
  const nickname = document.getElementById('nickname').value.trim();
  const room  = document.getElementById('room').value.trim();
  const number= document.getElementById('number').value.trim();
  if(!name){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'); return; }
  player = { title, name, nickname, room, number }; savePlayer();
  seed = Date.now() % 1000000; generateAllQuestions(); enterQuiz();
});
backBtn.addEventListener('click', ()=>{ currentIndex = clamp(currentIndex-1,0,9); renderQuestion(); updateNavState(); });
nextBtn.addEventListener('click', ()=>{ currentIndex = clamp(currentIndex+1,0,9); renderQuestion(); updateNavState(); });
submitBtn.addEventListener('click', ()=>{ const results = gradeAll(); showEnd(results); (results); });
playAgain.addEventListener('click', ()=>{ generateAllQuestions(); currentIndex=0; show(quizView); renderQuestion(); setupNav(); refreshSubmitState(); updateNavState(); });
backToHome.addEventListener('click', ()=>{ show(loginView); });

function enterQuiz(){
  const nickText = player.nickname ? ` ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${player.nickname}` : '';
  studentTag.textContent = `‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${player.title} ${player.name} ${player.room? '('+player.room+')':''} ${player.number? '#'+player.number:''}${nickText}`;
  seedTag.textContent = `‡∏ä‡∏∏‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå: ${seed}`;
  currentIndex = 0; show(quizView); renderQuestion(); setupNav(); refreshSubmitState();
}
function gradeAll(){ let score=0; const detail=[]; for(const q of questions){ let correct=false,correctAnsStr='',userAnsStr=''; if(q.kind==='matrix'){ correct=matEq(q.userAnswer,q.answer); correctAnsStr=fmtAnswerMatrixAsText(q.answer); userAnsStr=fmtAnswerMatrixAsText(q.userAnswer); } else { const userVal=Number(q.userAnswer); correct=(userVal===Number(q.answer)); correctAnsStr=String(q.answer); userAnsStr=String(userVal); } if(correct) score++; detail.push({ q:q.id, correct, correctAnswer:correctAnsStr, userAnswer:userAnsStr }); } return { score, total:questions.length, detail }; }
function showEnd({score,total,detail}){ show(endView); scoreLine.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${score} / ${total}`; answersList.innerHTML=''; for(const d of detail){ const q=questions.find(qq=>qq.id===d.q); const card=document.createElement('div'); card.className='ans-card'; let html=`<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap"><div><strong>‡∏Ç‡πâ‡∏≠ ${q.id}</strong></div><div class="badge ${d.correct?'ok':'no'}">${d.correct?'‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á':'‡∏ú‡∏¥‡∏î'}</div></div>`; html += `<div class="small" style="margin-top:6px">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</div>`; html += (q.kind==='matrix') ? fmtMatrixHTML(q.answer) : `<div class="mwrap mono" style="display:inline-block">${d.correctAnswer}</div>`; card.innerHTML=html; answersList.appendChild(card); } }
</script>

<script>
async function sendToSheet({score,total,detail}){
  if(!GAS_URL){
    sheetMsg.innerHTML = '<span class="warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets URL (GAS_URL)</span>';
    return;
  }

  const payload = {
    game: 'MatrixGame',
    title: player.title,
    name: player.name,
    nickname: player.nickname,
    room: player.room,
    number: player.number,
    score, total, seed
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ details ‡πÅ‡∏•‡πâ‡∏ß
  };

  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö URL-encoded ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight/CORS
  const form = new URLSearchParams();
  form.append('payload', JSON.stringify(payload));

  sheetMsg.innerHTML = '<span class="ok">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‚Ä¶</span>';

  try {
    const res = await fetch(GAS_URL, { method:'POST', body: form, credentials:'omit' });

    let ok = res.ok;
    try {
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('json')) {
        const js = await res.clone().json();
        ok = ok && (js && js.status === 'ok');
      }
    } catch (_) {}

    if (ok) {
      sheetMsg.innerHTML = '<span class="ok">‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß</span>';
      return;
    }
    throw new Error('Non-OK response');
  } catch (err) {
    // fallback ‡∏¢‡∏¥‡∏á‡πÅ‡∏ö‡∏ö no-cors ‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô error UI
    try {
      await fetch(GAS_URL, { method:'POST', mode:'no-cors', body: form, keepalive:true, credentials:'omit' });
      sheetMsg.innerHTML = '<span class="ok">‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
    } catch (e2) {
      sheetMsg.innerHTML = '<span class="warn">‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</span>';
    }
  }
}

// ================== INIT ==================
restorePlayer(); show(loginView);
</script>
</body>
</html>
